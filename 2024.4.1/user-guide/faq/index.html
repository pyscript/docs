
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../examples/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.3.1">
    
    
      
        <title>F.A.Q. - PyScript</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.046329b4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#faq" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">

  You're not viewing the latest version.
  <a href="../">
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>

      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PyScript" class="md-header__button md-logo" aria-label="PyScript" data-md-component="logo">
      
  <img src="../../assets/images/pyscript-black.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyScript
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              F.A.Q.
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_3" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_3">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PyScript" class="md-nav__button md-logo" aria-label="PyScript" data-md-component="logo">
      
  <img src="../../assets/images/pyscript-black.svg" alt="logo">

    </a>
    PyScript
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../beginning-pyscript/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beginning PyScript
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../conduct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code of Conduct
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../developers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Guide
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            User guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../what/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What is PyScript?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../first-steps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    First steps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../dom/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The DOM &amp; JavaScript
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../workers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../builtins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Builtin helpers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ffi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FFI in detail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../terminal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python terminal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../editor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python editor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../plugins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plugins
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../offline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Use Offline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example apps
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    F.A.Q.
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    F.A.Q.
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#common-errors" class="md-nav__link">
    Common Errors
  </a>
  
    <nav class="md-nav" aria-label="Common Errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sharedarraybuffer" class="md-nav__link">
    SharedArrayBuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#borrowed-proxy" class="md-nav__link">
    Borrowed Proxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-modules" class="md-nav__link">
    Python Modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#js-modules" class="md-nav__link">
    JS Modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-errors" class="md-nav__link">
    Reading Errors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-hints" class="md-nav__link">
    Common Hints
  </a>
  
    <nav class="md-nav" aria-label="Common Hints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyscript-latest" class="md-nav__link">
    PyScript latest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-bootstrap" class="md-nav__link">
    Worker Bootstrap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#about-classnew" class="md-nav__link">
    About Class.new
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyscript-events" class="md-nav__link">
    PyScript Events
  </a>
  
    <nav class="md-nav" aria-label="PyScript Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpyready" class="md-nav__link">
    m/py:ready
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mpydone" class="md-nav__link">
    m/py:done
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyall-done" class="md-nav__link">
    py:all-done
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-modules_1" class="md-nav__link">
    Python Modules
  </a>
  
    <nav class="md-nav" aria-label="Python Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hosting-on-github" class="md-nav__link">
    Hosting on GitHub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provide-your-own-file" class="md-nav__link">
    Provide your own file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zip-or-tar-gz-modules" class="md-nav__link">
    Zip or Tar Gz Modules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system" class="md-nav__link">
    File System
  </a>
  
    <nav class="md-nav" aria-label="File System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readwrite-content" class="md-nav__link">
    Read/Write Content
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-content" class="md-nav__link">
    Upload Content
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-content" class="md-nav__link">
    Download Content
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create_proxy" class="md-nav__link">
    create_proxy
  </a>
  
    <nav class="md-nav" aria-label="create_proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-pyodide" class="md-nav__link">
    In Pyodide
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-micropython" class="md-nav__link">
    In MicroPython
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to_js" class="md-nav__link">
    to_js
  </a>
  
    <nav class="md-nav" aria-label="to_js">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background_1" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    Caveats
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#common-errors" class="md-nav__link">
    Common Errors
  </a>
  
    <nav class="md-nav" aria-label="Common Errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sharedarraybuffer" class="md-nav__link">
    SharedArrayBuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#borrowed-proxy" class="md-nav__link">
    Borrowed Proxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-modules" class="md-nav__link">
    Python Modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#js-modules" class="md-nav__link">
    JS Modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-errors" class="md-nav__link">
    Reading Errors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-hints" class="md-nav__link">
    Common Hints
  </a>
  
    <nav class="md-nav" aria-label="Common Hints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyscript-latest" class="md-nav__link">
    PyScript latest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-bootstrap" class="md-nav__link">
    Worker Bootstrap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#about-classnew" class="md-nav__link">
    About Class.new
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyscript-events" class="md-nav__link">
    PyScript Events
  </a>
  
    <nav class="md-nav" aria-label="PyScript Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpyready" class="md-nav__link">
    m/py:ready
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mpydone" class="md-nav__link">
    m/py:done
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyall-done" class="md-nav__link">
    py:all-done
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-modules_1" class="md-nav__link">
    Python Modules
  </a>
  
    <nav class="md-nav" aria-label="Python Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hosting-on-github" class="md-nav__link">
    Hosting on GitHub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provide-your-own-file" class="md-nav__link">
    Provide your own file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zip-or-tar-gz-modules" class="md-nav__link">
    Zip or Tar Gz Modules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system" class="md-nav__link">
    File System
  </a>
  
    <nav class="md-nav" aria-label="File System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readwrite-content" class="md-nav__link">
    Read/Write Content
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-content" class="md-nav__link">
    Upload Content
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-content" class="md-nav__link">
    Download Content
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create_proxy" class="md-nav__link">
    create_proxy
  </a>
  
    <nav class="md-nav" aria-label="create_proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-pyodide" class="md-nav__link">
    In Pyodide
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-micropython" class="md-nav__link">
    In MicroPython
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to_js" class="md-nav__link">
    to_js
  </a>
  
    <nav class="md-nav" aria-label="to_js">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background_1" class="md-nav__link">
    Background
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    Caveats
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="faq">F.A.Q.</h1>
<p>This page contains most common questions and "<em>gotchas</em>" asked in <a href="https://discord.com/channels/972017612454232116/972017612454232119">our Discord channel</a> or within our community.</p>
<p>There are two major areas we'd like to help with, grouped here as <a href="#common-errors">common errors</a> and as <a href="#common-hints">common hints</a>.</p>
<h2 id="common-errors">Common Errors</h2>
<p>This area contains most common issues our users might face due technical reasons or some misconception around the topic.</p>
<h3 id="sharedarraybuffer">SharedArrayBuffer</h3>
<p>This is not by accident the very first, and most common, error our users might encounter while developing or deploying <em>PyScript</em> projects.</p>
<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Unable to use SharedArrayBuffer due insecure environment.
Please read requirements in MDN: ...</p>
</div>
<p>The error contains <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer#security_requirements">a link to MDN</a> but it's easy to get lost behind the amount of content provided by this topic.</p>
<p><strong>When</strong></p>
<p>This errors happens in one of these combined scenarios:</p>
<ul>
<li>the server doesn't provide the correct headers to handle security concerns or there is no <em>Service Worker</em> able to override headers, as described <a href="http://127.0.0.1:8000/user-guide/workers/">in the worker page</a> and ...<ul>
<li>there is a <code>worker</code> attribute in the <em>py</em> or <em>mpy</em> script element and the <a href="https://pyscript.github.io/polyscript/#extra-config-features">sync_main_only</a> flag is not present or not <code>True</code></li>
<li>there is a <code>&lt;script type="py-editor"&gt;</code> that uses a <em>worker</em> behind the scene</li>
<li>there is an explicit <em>PyWorker</em> or <em>MPWorker</em> bootstrap</li>
</ul>
</li>
</ul>
<p>The only exception is when the <code>sync_main_only = True</code> is part of the config with the following caveats:</p>
<ul>
<li>it is not possible to manipulate the DOM or do anything meaningful on the main thread directly because <em>Atomics</em> cannot guarantee sync-like locks within <em>worker</em> ↔ <em>main</em> operations</li>
<li>the only desired use case is to expose, from the worker, <code>pyscript.sync</code> utilities that will need to be awaited from the <em>main</em> once invoked</li>
<li>the worker can only <em>await</em> main related references, one after the other, so that <em>DX</em> is really degraded in case one still needs to interact with main</li>
</ul>
<p>If your project simply bootstraps on the <em>main</em> thread, none of this is relevant because no <em>worker</em> would need special features.</p>
<p><strong>Why</strong></p>
<p>The only way to make <code>document.getElementById('some-id').value</code> work out of a <em>worker</em> execution context is to use these two JS primitives:</p>
<ul>
<li><strong>SharedArrayBuffer</strong>, which allows multiple threads to read and / or write into a chunk of memory that is, like the name suggests, shared across threads</li>
<li><strong>Atomics</strong>, which is needed to both <code>wait(sab, index)</code> and <code>notify(sab, index)</code> to unlock the awaiting thread</li>
</ul>
<p>While a <em>worker</em> is waiting for some operation on main to happen, this is not using the CPU, it just idles until that index of the shared buffer gets notified, effectively never blocking the <em>main</em> thread, still pausing its own execution until such buffer is notified for changes.</p>
<p>As overwhelming or complicated as this might sounds, these two fundamental primitives make <em>main</em> ↔ <em>worker</em> interoperability an absolute wonder in term of <em>DX</em> so that we encourage to always prefer <em>workers</em> over <em>main</em> scripts, specially when it comes to <em>Pyodide</em> related projects with its heavier bootstrap or computation abilities, yet still delivering a <em>main-like</em> development experience.</p>
<p>Unfortunately, due past security concerns and attacks to shared buffers, each server or page needs to allow extra security to prevent malicious software to also read or write into these buffers but be assured that if you own your code, your project, and you trust the modules or 3rd party code you need and use, <strong>there are no security concerns around this topic within this project</strong>, it's simply an unfortunate "<em>one rule catch all</em>" standard any server can either enable or disable as it pleases.</p>
<h3 id="borrowed-proxy">Borrowed Proxy</h3>
<p>This is another classic error that might happen with listeners, timers or any other circumstance where a <em>Python</em> callback might be lazily invoked in the <em>JS</em> side of affair:</p>
<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Uncaught Error: This borrowed proxy was automatically destroyed at the end of a function call. Try using create_proxy or create_once_callable.
For more information about the cause of this error, use <code>pyodide.setDebug(true)</code></p>
</div>
<p><strong>When</strong></p>
<p>This error usually happens in <em>Pyodide</em> only related project, and only if a <em>Python</em> callback has been directly passed along as <em>JS</em> function parameter:</p>
<div class="language-python highlight"><span class="filename">An expired borrowed proxy example</span><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">js</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># will throw the error in case</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">js</span><span class="o">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Please note that this error <em>does not happen</em> if the code is executed in a worker and the <em>JS</em> reference comes from the <em>main</em> thread:</p>
<div class="language-python highlight"><span class="filename">A worker has no borrowed issue</span><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">window</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">window</span><span class="o">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>In this case, because proxies cannot survive a <em>worker</em> ↔ <em>main</em> communication, the <em>Python</em> reference gets inevitably translated into a <em>JS</em> function and its unique <em>id</em> propagated and awaited to be released with a returning value, so that technically that lambda can be freed without causing any issue.</p>
<p>We provided an experimental way to always act in a similar way on both main and workers through the <code>experimental_create_proxy = "auto"</code> <em>config</em> flag.</p>
<p>This flag tries to intercept all <em>Python</em> proxies passed to a <em>JS</em> callback and it orchestrates an automatic memory free operation through the <em>JS</em> garbage collector.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">FinalizationRegistry</a> is the primitive used to do so. It is not observable and nobody can predict when it will run to free, hence destroy, retained <em>Python</em> proxies. This means that <em>RAM</em> consumption might be slightly higher, but it's the <em>JS</em> engine responsibility to guarantee that when such <em>RAM</em> consumption is too high, that finalization registry would call and free all retained proxies, leaving room for more <em>RAM</em>.</p>
</div>
<p><strong>Why</strong></p>
<p>Most <em>WASM</em> based runtimes have their own garbage collector or memory management but when their references are passed along another programming language they cannot guarantee these references will ever be freed, or better, they lose control over that memory allocation because they cannot know when such allocation won't be needed anymore.</p>
<p>The theoretical solution to this is to allow users to explicitly create proxies of these references and then still explicitly invoke <code>proxy.destroy()</code> to communicate to the original <em>PL</em> that such reference and allocated can be freed, if not used internally for other reasons, effectively invalidating that <em>JS</em> reference, resulting into a "<em>dead reference</em>" that its garbage collector might get rid of when it's convenient.</p>
<p>At the practical level though, there are dozen use cases where users just don't, or can't, disambiguate the need for such proxy creation or easily forget to call <code>destroy()</code> at the right time.</p>
<p>To help most common use cases, <em>Pyodide</em> provide various <a href="https://pyodide.org/en/stable/usage/api/python-api/ffi.html#module-pyodide.ffi.wrappers">ffi.wrappers</a> but in theory none of these is strictly needed if we orchestrate a <em>FinalizationRegistry</em> to automatically <code>destroy</code> those proxies when not needed anymore, moving the responsibility from the user to the running <em>JS</em> engine, which is why we have provided the <code>experimental_create_proxy = "auto"</code> <em>config</em> flag.</p>
<h3 id="python-modules">Python Modules</h3>
<p>There is a huge difference in what can be imported in <em>pyodide</em> VS what can be imported in <em>micropython</em> and the reason is:</p>
<ul>
<li><em>pyodide</em> can import modules at runtime as long as these <a href="https://pyodide.org/en/stable/usage/packages-in-pyodide.html">have been ported</a> to it</li>
<li><em>micropython</em> can only import at runtime <em>Python</em> only modules, or better, modules that use the same syntax and primitives allowed in <em>micropython</em> itself</li>
</ul>
<p>Behind the scene <em>pyodide</em> uses <a href="https://github.com/pyodide/micropip">micropip</a> while <em>micropython</em> uses <a href="https://docs.micropython.org/en/latest/reference/packages.html#installing-packages-with-mip">mip</a>.</p>
<p>Due different architecture though, <em>micropython</em> cannot expose modules that require native compilation / translation for the resulting <em>WASM</em> artifact, but we're working on a "<em>super charged</em>" version of <em>micropython</em> that would bring at least the most common requested modules too (i.e. <em>numpy</em>).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Accordingly to the current state, it could be hard to seamlessly port 1:1 a Pyodide project to MicroPython: expect possible issues while trying but please consider the mentioned caveats around or be sure the issue is something we could actually fix on our side or file an upstream issue otherwise, thank you!</p>
</div>
<h3 id="js-modules">JS Modules</h3>
<p>In more than one occasion, since we introduced the <code>pyscript.js_modules</code> feature, our users have encountered errors like:</p>
<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Uncaught SyntaxError: The requested module './library.js' does not provide an export named 'default'</p>
</div>
<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Uncaught SyntaxError: The requested module './library.js' does not provide an export named 'util'</p>
</div>
<p><strong>When</strong></p>
<p>99% of the time the issue with JS modules is that what we are importing are not, effectively, JS modules.</p>
<p>When the file uses <code>module.exports</code> or <code>globalThis.util</code> or anything that is not standard <em>ECMAScript</em> syntax for modules, such as <code>export default value</code> or <code>export const util = {}</code>, we cannot retrieve that file content in a standard way.</p>
<p>To <strong>solve</strong> this issue various <em>CDNs</em> provide a way to automatically deliver <em>ESM</em> (aka: <em>ECMAScript Modules</em>) out of the box and one of the most reliable and famous one is <a href="https://esm.run/">esm.run</a>.</p>
<div class="language-html highlight"><span class="filename">An example of esm.run</span><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">&lt;</span><span class="nt">mpy-config</span><span class="p">&gt;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>[js_modules.main]
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>&quot;https://esm.run/d3&quot; = &quot;d3&quot;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="p">&lt;/</span><span class="nt">mpy-config</span><span class="p">&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;mpy&quot;</span><span class="p">&gt;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="kr">from</span><span class="w"> </span><span class="nx">pyscript</span><span class="p">.</span><span class="nx">js_modules</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">d3</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>Alternatively, please be sure any <code>.js</code> file you are importing as module actually uses <code>export ...</code> within its content and, if that's not the case, ask for an <code>.mjs</code> counter-equivalent of that library or framework or trust <code>esm.run</code> produced artifacts.</p>
<p><strong>Why</strong></p>
<p>Even if standard <em>JS</em> modules have been around since 2015, a lot of old to even new libraries still produce files that are incompatible with modern <em>JS</em> expectations.</p>
<p>There is no logical or simple explanation to this situation for modules that target browsers, but there are various server side related projects that still rely on the legacy, <em>NodeJS</em> only, module system (aka: <em>CommonJS</em>).</p>
<p>Until that legacy module system exists, be aware some module might require special care.</p>
<h3 id="reading-errors">Reading Errors</h3>
<p>Each interpreter might provide different error messages but the easy way to find what's going on is, most of the time, described in the last line with both <em>Pyodide</em> and <em>MicroPython</em>:</p>
<div class="language-text highlight"><span class="filename">A Pyodide Error</span><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Traceback (most recent call last):
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>  File &quot;/lib/python311.zip/_pyodide/_base.py&quot;, line 501, in eval_code
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    .run(globals, locals)
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>     ^^^^^^^^^^^^^^^^^^^^
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>  File &quot;/lib/python311.zip/_pyodide/_base.py&quot;, line 339, in run
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    coroutine = eval(self.code, globals, locals)
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>  File &quot;&lt;exec&gt;&quot;, line 1, in &lt;module&gt;
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>NameError: name &#39;failure&#39; is not defined
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></code></pre></div>
<div class="language-text highlight"><span class="filename">A MicroPython Error</span><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Traceback (most recent call last):
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>NameError: name &#39;failure&#39; isn&#39;t defined
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</span></code></pre></div>
<p>The same applies when the error is shown in devtools/console where unfortunately the stack right after the error message might be a bit distracting but it's still well separated from the error message itself.</p>
<h2 id="common-hints">Common Hints</h2>
<p>This area contains most common questions, hacks, or hints we provide to the community.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We have a lovely <em>PyScript</em> contributor, namely <a href="https://github.com/jeffersglass">Jeff Glass</a>, who is maintaining an awesome blog full of <a href="https://pyscript.recipes/">PyScript Recipes</a> with even more use cases and solutions. If you cannot find what you are looking for in here, please do check over there as it's very likely there is something close to the answer you are looking for.</p>
</div>
<h3 id="pyscript-latest">PyScript latest</h3>
<p>For various reasons previously discussed at length, we decided to remove our <code>latest</code> channel from our own CDN.</p>
<p>We were not super proud of users trusting that channel coming back with suddenly broken projects so we now <a href="https://github.com/pyscript/pyscript/releases">release only official versions</a> everyone can pin-point in time.</p>
<p>We are also developing behind the scene through <em>npm</em> to be able to test in the wild breaking changes and whatnot and it's no secret that <em>CDNs</em> could also deliver our "<em>canary</em>" or "<em>development</em>" channel so that we're better off telling you exactly which links one should use to have the latest, whenever latest lands on the <em>CDN</em> which is usually within 24 hours from the last <em>npm</em> version change.</p>
<p>We still <strong>do not guarantee any stability</strong> around this channel so be aware this is never a good idea to use in production, documentation might lack behind landed changes, APIs might break or change too, and so on.</p>
<p>If you are still reading though, this is the template to have <em>latest</em>:</p>
<div class="language-html highlight"><span class="filename">PyScript latest</span><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/npm/@pyscript/core/dist/core.css&quot;</span><span class="p">&gt;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/npm/@pyscript/core/dist/core.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not use shorter urls or other CDNs because the project needs both the correct headers to eventually run in <em>workers</em> and it needs to find its own assets at runtime so that other CDN links might result into a <strong>broken experience</strong> out of the box.</p>
</div>
<h3 id="worker-bootstrap">Worker Bootstrap</h3>
<p>In some occasion users asked to bootstrap a <em>pyodide</em> or <em>micropython</em> worker directly via <em>JS</em>.</p>
<div class="language-html highlight"><span class="filename">PyScript Worker in JS</span><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span><span class="p">&gt;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="c1">// use sourceMap for @pyscript/core or change to a CDN</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="nx">PyWorker</span><span class="p">,</span><span class="w"> </span><span class="c1">// Pyodide Worker</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nx">MPWorker</span><span class="w">  </span><span class="c1">// MicroPython Worker</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@pyscript/core&#39;</span><span class="p">;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">MPWorker</span><span class="p">(</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="c1">// Python code to execute</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="s1">&#39;./micro.py&#39;</span><span class="p">,</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="c1">// optional details or config with flags</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sync_main_only</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="c1">//          ^ just as example ^</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">  </span><span class="c1">// &quot;heavy computation&quot;</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">worker</span><span class="p">.</span><span class="nx">sync</span><span class="p">.</span><span class="nx">doStuff</span><span class="p">();</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">  </span><span class="c1">// kill the worker when/if needed</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">  </span><span class="nx">worker</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<div class="language-python highlight"><span class="filename">micro.py</span><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">sync</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="k">def</span> <span class="nf">do_stuff</span><span class="p">():</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;heavy computation&quot;</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">sync</span><span class="o">.</span><span class="n">doStuff</span> <span class="o">=</span> <span class="n">do_stuff</span>
</span></code></pre></div>
<h3 id="about-classnew">About Class.new</h3>
<p>In more than one occasion users asked why there's the need to write <code>Class.new()</code>, when the class comes from the <em>JS</em> world, as opposite of just typing <code>Class()</code> like it is for <em>Python</em>.</p>
<p>The reason is very technical and related to <em>JS</em> history and poor introspection ability in this regard:</p>
<ul>
<li><code>typeof function () {}</code> and <code>typeof class {}</code> produce the same outcome: <strong>function</strong>, making it very hard to disambiguate the intention as both are valid and, strawberry on top, legacy <em>JS</em> used <code>function</code> to create instances, not <code>class</code>, so that legacy code might still use that good'ol convention</li>
<li>the <em>JS</em> proxy has <code>apply</code> and <code>construct</code> traps but because of the previous point, it's not possible to be sure that <code>apply</code> meant to <code>construct</code> the instance</li>
<li>diffrently from <em>Python</em>, just invoking <code>Class()</code> throws an error in <em>JS</em> if that is actually defined as <code>class {}</code> so that <code>new</code> is mandatory in the that case</li>
<li>the <code>new Class()</code> is invalid syntax in <em>Python</em>, there is a need to disambiguate the intent</li>
<li>the capitalized naming convention is lost once the code gets minified on the <em>JS</em> side, hence it's unreliable as convention</li>
<li>the <code>Class.new()</code> explicitly describe the intent ... it's true that it's ugly, when mixed up with <em>Python</em> classes too, but at least it clearly indicates that such <code>Class</code> is a <em>JS</em> one, not a <em>Python</em> thing</li>
</ul>
<p>As summary, we all agree that in an ideal world just having <code>Class()</code> all over would be cool, but unless the <em>JS</em> code has been created via quite outdated artifacts we need to use the <code>.new()</code> convention which is adopted by both <em>pyodide</em> and <em>micropython</em>.</p>
<p>To close this paragraph, here an example of how it was possible before to avoid <code>new</code> <em>VS</em> now:</p>
<div class="language-js highlight"><span class="filename">Legacy VS Modern JS</span><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// legacy pseudo pattern: it allows just Legacy()</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1">// with or without `new Legacy` requirement</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kd">function</span><span class="w"> </span><span class="nx">Legacy</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">Legacy</span><span class="p">))</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Legacy</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="c1">// bootstrap the instance</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="p">}</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="c1">// legacy way to define classes</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="nx">Legacy</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...};</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="c1">// modern JS classes: private fields, own fields,</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1">// super and other goodness available to devs</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="kd">class</span><span class="w"> </span><span class="nx">Modern</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="c1">// throws error: it requires `new Modern`</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="nx">Modern</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="pyscript-events">PyScript Events</h3>
<p>Beside <em>hooks</em>' lifecycle, <em>PyScript</em> also dispatches specific events that might help users to work around its state:</p>
<h4 id="mpyready">m/py:ready</h4>
<p>Both <code>mpy:ready</code> and <code>py:ready</code> events are dispatched per every <em>PyScript</em> related element found on the page, being this a <code>&lt;script type="py"&gt;</code>, a <code>&lt;py-script&gt;</code> or any <em>mpy</em> counterpart.</p>
<p>Please <strong>note</strong> that these events are dispatched <em>right before</em> the code gets eventually executed, hence before the interpreter got a chance to run the code but always <em>after</em> the interpreter has already been bootstrapped.</p>
<div class="language-html highlight"><span class="filename">A py:ready example</span><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;py:ready&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="c1">// show running for an instance</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">);</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="nx">status</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">;</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="cm">&lt;!-- show bootstrapping right away --&gt;</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;status&quot;</span><span class="p">&gt;</span>bootstrapping<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;py&quot;</span> <span class="na">worker</span><span class="p">&gt;</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="kr">from</span><span class="w"> </span><span class="nx">pyscript</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nb">document</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">show</span><span class="w"> </span><span class="nx">done</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="nx">running</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span><span class="nx">status</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;done&quot;</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>As a matter of fact, if you are missing the previous <em>modal</em> showing a spinner while <em>pyodide</em> bootstrapped, it is fairly easy to provide a similar experience through this event: show a modal first, then close it once <code>py:ready</code> is triggered.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>On the <em>main</em> thread, <em>pyodide</em> blocks the <em>UI</em> until it's finished bootstrapping itself.
This means that previous example without <code>worker</code> attribute will skip rendering <code>running</code> text because it happens at the same <em>UI</em> update that happens after the code has been executed.
If needed, one can always <code>console.log</code> instead to be sure that event happened.</p>
</div>
<h4 id="mpydone">m/py:done</h4>
<p>As the name might suggest, <code>mpy:done</code> and <code>py:done</code> events events are dispatched <em>after</em> the <em>sync</em> or <em>async</em> code has finished its execution.</p>
<div class="language-html highlight"><span class="filename">A py:done example</span><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;py:ready&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">        </span><span class="c1">// show running for an instance</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">);</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">        </span><span class="nx">status</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;running&#39;</span><span class="p">;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;py:done&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">        </span><span class="c1">// show done after logging &quot;Hello 👋&quot;</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">);</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">        </span><span class="nx">status</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;done&#39;</span><span class="p">;</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="cm">&lt;!-- show bootstrapping right away --&gt;</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;status&quot;</span><span class="p">&gt;</span>bootstrapping<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;py&quot;</span> <span class="na">worker</span><span class="p">&gt;</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="nx">print</span><span class="p">(</span><span class="s2">&quot;Hello 👋&quot;</span><span class="p">)</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If your async code never exits due some infinite loop or it uses some orchestration that keeps it running forever, such as <code>code</code> and <code>code.interact()</code> these events might never get triggered because the code actually is never really <em>done</em> so it cannot reach its own end of execution.</p>
</div>
<h4 id="pyall-done">py:all-done</h4>
<p>This event is special because it really groups all possible <em>mpy</em> or <em>py</em> scripts found on the page, no matter the interpreter.</p>
<p>In this example we'll see MicroPython waving before Pyodide and finally an <em>everything is done</em> message in <em>devtools</em>.</p>
<div class="language-html highlight"><span class="filename">A py:all-done example</span><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;py:all-done&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;everything is done&quot;</span><span class="p">);</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;mpy&quot;</span> <span class="na">worker</span><span class="p">&gt;</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="nx">print</span><span class="p">(</span><span class="s2">&quot;MicroPython 👋&quot;</span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;py&quot;</span> <span class="na">worker</span><span class="p">&gt;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="nx">print</span><span class="p">(</span><span class="s2">&quot;Pyodide 👋&quot;</span><span class="p">)</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<h3 id="python-modules_1">Python Modules</h3>
<p>There are a few ways to host or include other modules in <em>PyScript</em>:</p>
<ul>
<li>having the module already part of either <em>Pyodide</em> or <em>MicroPython</em> distribution</li>
<li>hosting on <em>GitHub</em> some file that need to be discovered and fetched at runtime as <em>package</em></li>
<li>provide your own <code>module.py</code> as single file to include in the File System</li>
<li>create a folder with structured files and sub folders that can easily be <em>zipped</em> or <em>tar.gz</em> as unique entry, and let the File System do the rest</li>
</ul>
<h4 id="hosting-on-github">Hosting on GitHub</h4>
<p>Beside modules already available behind the interpreter packages manager, it is possible to point directly at files in GitHub (or GitLab, or anywhere else the file can be downloaded without issues):</p>
<div class="language-python highlight"><span class="filename">MicroPython mip example</span><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Install default version from micropython-lib</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">mip</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="s2">&quot;keyword&quot;</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># Install from raw URL</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">mip</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/micropython/micropython-lib/master/python-stdlib/bisect/bisect.py&quot;</span><span class="p">)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># Install from GitHub shortcut</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">mip</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="s2">&quot;github:jeffersglass/some-project/foo.py&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>These URLs are recognized as <em>packages</em> entries in the <em>config</em> and as long as the URL allows <em>CORS</em> (fetching files from other domains) everything should be fine.</p>
<h4 id="provide-your-own-file">Provide your own file</h4>
<p>Instead of using the <em>config</em> to define packages one can use the <code>files</code> field to bring modules in the runtime.</p>
<div class="language-html highlight"><span class="filename">Module as File</span><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="p">&lt;</span><span class="nt">mpy-config</span><span class="p">&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>[files]
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>&quot;./modules/bisect.py&quot; = &quot;./bisect.py&quot;
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="p">&lt;/</span><span class="nt">mpy-config</span><span class="p">&gt;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;mpy&quot;</span><span class="p">&gt;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nx">bisect</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<h4 id="zip-or-tar-gz-modules">Zip or Tar Gz Modules</h4>
<p>With this approach it's possible to archive in a compressed way the module content with a simple to complex structure:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>my_module/__init__.py
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>my_module/util.py
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>my_module/sub/sub_util.py
</span></code></pre></div>
<p>Once archived as <code>.zip</code> or as <code>.tar.gz</code> in a way that contains the <em>my_module</em> folder and its content, it's possible to host this remotely or simply have it reachable locally:</p>
<div class="language-html highlight"><span class="filename">Module as File</span><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">&lt;</span><span class="nt">mpy-config</span><span class="p">&gt;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>[files]
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>&quot;./my_module.zip&quot; = &quot;./*&quot;
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">&lt;/</span><span class="nt">mpy-config</span><span class="p">&gt;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;mpy&quot;</span><span class="p">&gt;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">  </span><span class="kr">from</span><span class="w"> </span><span class="nx">my_module</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">util</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">  </span><span class="kr">from</span><span class="w"> </span><span class="nx">my_module</span><span class="p">.</span><span class="nx">sub</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">sub_util</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>Please <strong>note</strong> the <code>./*</code> convention, through a <code>.zip</code> or <code>.tar.gz</code> source, where the target folder with a star <code>*</code> will contain anything present in the source archive, in this example the whole <em>my_module</em> folder.</p>
<h3 id="file-system">File System</h3>
<p>The first thing to understand about <em>PyScript</em> File System operations is that each interpreter provides <em>its own</em> <em>Virtual File System</em> that works <strong>only in memory</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We don't have yet a way to provide a shared, user's browser persistent, File System, so that any time we load or store and then read files we're doing that through the <em>RAM</em> and the current session: nothing is shared, nothing is stored, nothing persists!</p>
</div>
<h4 id="readwrite-content">Read/Write Content</h4>
<p>The easiest way to add content to the virtual <em>FS</em> is by using native <em>Python</em> files operations:</p>
<div class="language-python highlight"><span class="filename">Writing to a text file</span><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hello vFS&quot;</span><span class="p">)</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="c1"># read the written content</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="n">source</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="n">source</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></div>
<p>Combined with our <code>pyscript.fetch</code> utility, it's also possible to store from the web more complex data.</p>
<div class="language-python highlight"><span class="filename">Writing file as binary</span><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># assume an `async` attribute / execution</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">fetch</span><span class="p">,</span> <span class="n">window</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">href</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">href</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./page.html&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">fetch</span><span class="p">(</span><span class="n">href</span><span class="p">)</span><span class="o">.</span><span class="n">bytearray</span><span class="p">())</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="n">dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="c1"># read the current HTML page</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="n">source</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./page.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="n">source</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></div>
<h4 id="upload-content">Upload Content</h4>
<p>Through the DOM API it's possible to also upload a file and store it into the virtual <em>FS</em>.</p>
<p>The following example is just one of the ways one can do that, but it's a pretty simple one and based on the very same code and logic already seen in the previous paragraph:</p>
<div class="language-html highlight"><span class="filename">Upload file into vFS</span><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span><span class="p">&gt;</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;mpy&quot;</span><span class="p">&gt;</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="kr">from</span><span class="w"> </span><span class="nx">pyscript</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nb">document</span><span class="p">,</span><span class="w"> </span><span class="nx">fetch</span><span class="p">,</span><span class="w"> </span><span class="nb">window</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">def</span><span class="w"> </span><span class="nx">on_change</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nx">per</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">file</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">files</span><span class="o">:</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">temporary</span><span class="w"> </span><span class="nx">URL</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">            </span><span class="nx">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">fetch</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">save</span><span class="w"> </span><span class="nx">its</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="nx">somewhere</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">            </span><span class="kd">with</span><span class="w"> </span><span class="nx">open</span><span class="p">(</span><span class="nx">f</span><span class="s2">&quot;./{file.name}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">dest</span><span class="o">:</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">                </span><span class="nx">dest</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="nx">tmp</span><span class="p">).</span><span class="nx">bytearray</span><span class="p">())</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">                </span><span class="nx">dest</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">revoke</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">tmp</span><span class="w"> </span><span class="nx">URL</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="nx">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;input[type=file]&quot;</span><span class="p">)</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">    </span><span class="nx">input</span><span class="p">.</span><span class="nx">onchange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">on_change</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></code></pre></div>
<h4 id="download-content">Download Content</h4>
<p>Once a file is present in the virtual File System, it's always possible to create a temporary link which goal is to download such file:</p>
<div class="language-python highlight"><span class="filename">Download file from vFS</span><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">):</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">document</span><span class="p">,</span> <span class="n">ffi</span><span class="p">,</span> <span class="n">window</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>        <span class="c1"># this is Pyodide specific</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>        <span class="n">buffer</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">Uint8Array</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>        <span class="n">details</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">to_js</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">mime_type</span><span class="p">})</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>        <span class="c1"># this is JS specific</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>        <span class="n">file</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">new</span><span class="p">([</span><span class="n">buffer</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="n">dest</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>        <span class="n">dest</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>        <span class="n">dest</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>        <span class="n">dest</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>        <span class="c1"># here a timeout to window.URL.revokeObjectURL(tmp)</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>        <span class="c1"># should keep the memory clear for the session</span>
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The presented utility works only on <em>Pyodide</em> at the moment, as there is no <code>from_</code> or <code>assign</code> convention in <em>MicroPython</em>. Once this is fixed or a better example is discovered the example will be updated too so that all of them should work in both interpreters.</p>
</div>
<h3 id="create_proxy">create_proxy</h3>
<p>Explained in details <a href="../ffi/">in the ffi page</a>, it's probably useful to cover the <em>when</em> <code>create_proxy</code> is needed at all.</p>
<p>To start with, there's a subtle difference between <em>Pyodide</em> and <em>MicroPython</em> around this topic, with or without using our <code>pyscript.ffi</code>, as it just forwards the utility behind scene.</p>
<h5 id="background">Background</h5>
<p>A <em>Python</em> function executed in the <em>JS</em> world inevitably needs to be wrapped in a way that, once executed, both its native (<em>Python</em>) function reference and any passed argument/parameter to such function can be normalized to <em>Python</em> references before such invocation happens.</p>
<p>The <em>JS</em> primitive to do so is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy</a> one, which enables "<em>traps</em>" such as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/apply">apply</a> to do extra work before any result is actually returned from such invocation.</p>
<p>Once the <code>apply(target, self, args)</code> trap is invoked:</p>
<ul>
<li>the interpreter must find which <code>target</code> in the current <em>WASM</em> running code that needs to be invoked</li>
<li>the <code>self</code> context for regular functions is likely ignored for common cases, but it's likely desired to eventually define <code>python.method()</code> invokes when these happen in the <em>JS</em> world</li>
<li>the <code>args</code> is a list of passed arguments where any proxy coming from <em>Python</em> must be resolved as reference, any primitive might be eventually converted into its <em>Python</em> primitive representation, if needed, and any <em>JS</em> reference must be translated into <em>Python</em> like objects / references</li>
</ul>
<p>This orchestration might feel convoluted for many or obvious for others, yet the detail behind the scene is that such <code>target</code> reference <em>needs to exist</em> on the <em>WASM</em> runtime in order to be executed when the <em>JS</em> world asks for it ... so here the caveat: globally available functions might outlive any <em>JS</em> runtime interoperability in the <em>WASM</em> world but locally scoped or runtime functions cannot be retained forever!</p>
<div class="language-python highlight"><span class="filename">A basic Python to JS callback</span><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">import</span> <span class="nn">js</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">js</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>  <span class="s2">&quot;custom:event&quot;</span><span class="p">,</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>  <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="p">)</span>
</span></code></pre></div>
<p>In this scenario that <code>lambda</code> has no meaning or references in the running <em>Python</em> code, it's just delegated to the <em>JS</em> runtime / environment but it <em>must exist</em> whenever that <code>custom_event</code> is dispatched, hence triggered, or emitted, in the <em>JS</em> world.</p>
<p>From a pure architectural point of view there is literally nothing that defines in that user explicit intent how long that <code>lambda</code> should be kept alive in the current <em>Python</em> program while from the <em>JS</em> point of view that callback might never even be needed or invoked (i.e. the <code>custom:event</code> never happens ... which is a forever pending <em>lambda</em> use case).</p>
<p>Because all interpreters do care about memory consumption and have some <em>WASM</em> memory constrain to deal with, <code>create_proxy</code> (or any similar API) has been provided to delegate the responsibility to kill those references to the user, specially for unknown, in time, invocations scenarios like the one described in here.</p>
<p><strong>On the other hand</strong>, when a <em>Python</em> callback is attached, as opposite of being just passed as argument, to a specific foreign instance, it is fairly easy for the <em>WASM</em> runtime to know when such <code>lambda</code> function, or any other non global function, could be freed from the memory.</p>
<div class="language-python highlight"><span class="filename">A sticky lambda</span><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">document</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="c1"># logs &quot;click&quot; if nothing else stopped propagation</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">document</span><span class="o">.</span><span class="n">onclick</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span></code></pre></div>
<p>"<em>How is that easy?</em>" is a valid question and the answer is that if the runtime has <em>JS</em> bindings, hence it's capable of dealing with <em>JS</em> references, that <code>document</code> would be a well known <em>JSProxy</em> that points to some underlying <em>JS</em> reference.</p>
<p>In this case there's usually no need to use <code>create_proxy</code> because that reference is well understood and the interpreter can use the <em>FinalizationRegistry</em> to simply destroy that lambda, or decrease its reference counting, whenever the underlying <em>JS</em> reference is not needed anymore, hence finalized after its own release from <em>JS</em>.</p>
<p>Sure thing this example is fairly poor, because a <code>document</code> reference in the <em>JS</em> world would live "<em>forever</em>", but if instead of a <code>document</code> there was a live DOM element, as soon as that element gets replaced and it's both not live or referenced anymore, the <em>FinalizationRegistry</em> would inform the <em>WASM</em> based runtime that such reference is gone, and whatever was attached to it behind the scene can be gone too.</p>
<h4 id="in-pyodide">In Pyodide</h4>
<p>The <code>create_proxy</code> utility is exported <a href="https://pyodide.org/en/stable/usage/api/python-api/ffi.html#module-pyodide.ffi.wrappers">among others</a> to smooth out and circumvent memory leaks in the long run.</p>
<p>Using it separately from other utilities though requires some special care, most importantly, it requires that the user invokes that <code>destroy()</code> method when such callback is not needed anymore, hence it requires users to mentally track callbacks lifecycle, but that's not always possible for at least these reasons:</p>
<ul>
<li>if the callback is passed to 3rd party libraries, the reference is kinda "<em>lost in a limbo</em>" where who knows when that reference could be actually freed</li>
<li>if the callback is passed to listeners or timers, or even promises based operations, it's pretty unpredictable and counter intuitive, also a bad <em>DX</em>, to try to track those cases</li>
</ul>
<p>Luckily enough, the <em>Promise</em> use case is automatically handled by <em>Pyodide</em> runtime, but we're left with other cases:</p>
<div class="language-python highlight"><span class="filename">Pyodide VS create_proxy</span><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">ffi</span><span class="p">,</span> <span class="n">window</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1"># this is needed even if `print` won&#39;t ever need</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="c1"># to be freed from the Python runtime</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">window</span><span class="o">.</span><span class="n">setTimeout</span><span class="p">(</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>  <span class="n">ffi</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="nb">print</span><span class="p">),</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>  <span class="mi">100</span><span class="p">,</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>  <span class="s2">&quot;print&quot;</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="p">)</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="c1"># this is needed not because `print` is used</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="c1"># but because otherwise the lambda is gone</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="n">window</span><span class="o">.</span><span class="n">setTimeout</span><span class="p">(</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>  <span class="n">ffi</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>  <span class="p">),</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>  <span class="mi">100</span><span class="p">,</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>  <span class="s2">&quot;lambda&quot;</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="p">)</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="k">def</span> <span class="nf">print_type</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="c1"># this is needed even if `print_type`</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="c1"># is not a scoped / local function, rather</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="c1"># a never freed global reference in this Python code</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="n">window</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>  <span class="s2">&quot;some:event&quot;</span><span class="p">,</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>  <span class="n">ffi</span><span class="o">.</span><span class="n">create_proxy</span><span class="p">(</span><span class="n">print_type</span><span class="p">),</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>  <span class="c1"># despite this intent, the proxy</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>  <span class="c1"># will be trapped forever if not destroyed</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>  <span class="n">ffi</span><span class="o">.</span><span class="n">to_js</span><span class="p">({</span><span class="s2">&quot;once&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="p">)</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="c1"># this does NOT need create_function as it is</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="c1"># attached to an object reference, hence observed to free</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="n">window</span><span class="o">.</span><span class="n">Object</span><span class="p">()</span><span class="o">.</span><span class="n">no_create_function</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>To simplify some of this orchestration we landed the <code>experimental_create_proxy = "auto"</code> flag which goal is to intercept <em>JS</em> world callbacks invocation, and automatically proxy and destroy any proxy that is not needed or used anymore in the <em>JS</em> environment.</p>
<p>Please give it a try and actually try to <em>not</em> ever use, or need, <code>create_proxy</code> at all, and tell us when it's needed instead, than you!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When it comes to <em>worker</em> based code, no <em>Proxy</em> can survive a roundtrip to the <em>main</em> thread and back.
In this scenario we inevitably need to orchestrate the dance differently and reference instead <em>Python</em> callbacks, or een <em>JS</em> one, as these travel by their unique <em>id</em>, not their identity on the <em>worker</em>.
We orchestrate the <em>free</em> dance automatically because nothing would work otherwise so that long story short, if your <em>pyodide</em> code runs from a <em>worker</em>, you likely never need to use <code>create_proxy</code> at all.</p>
</div>
<h4 id="in-micropython">In MicroPython</h4>
<p>Things are definitively easier to reason about in this environment, but mostly because it doesn't expose (yet?) a <code>destroy()</code> utility for created proxies.</p>
<p>Accordingly, using <code>create_proxy</code> in <em>micropython</em> might be needed only to have portable code, as proxies are created anyway when <em>Python</em> code refers to a callback and is passed to any <em>JS</em> utility, plus proxies won't be created multiple times if these were already proxy of some <em>Python</em> callback.</p>
<p>All the examples that require <code>create_proxy</code> in <em>Pyodide</em>, won't bother <em>MicroPython</em> but these would be also kinda not needed in general.</p>
<div class="language-python highlight"><span class="filename">MicroPython VS create_proxy</span><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">from</span> <span class="nn">pyscript</span> <span class="kn">import</span> <span class="n">window</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># this works</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">window</span><span class="o">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;print&quot;</span><span class="p">)</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="c1"># this also works</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="n">window</span><span class="o">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;lambda&quot;</span><span class="p">)</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="k">def</span> <span class="nf">print_type</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="c1"># this works too</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="n">window</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>  <span class="s2">&quot;some:event&quot;</span><span class="p">,</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>  <span class="n">print_type</span><span class="p">,</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>  <span class="n">ffi</span><span class="o">.</span><span class="n">to_js</span><span class="p">({</span><span class="s2">&quot;once&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="p">)</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="c1"># and so does this</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="n">window</span><span class="o">.</span><span class="n">Object</span><span class="p">()</span><span class="o">.</span><span class="n">no_create_function</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently <em>MicroPython</em> doesn't provide a <code>destroy()</code> method so it's actually preferred, in <em>MicroPython</em> projects, to not use or need the <code>create_proxy</code> because it lacks control over destroying it while it's up to the interpreter to decide when or how proxies can be destroyed.</p>
</div>
<h3 id="to_js">to_js</h3>
<p>Also xplained in details <a href="../ffi/">in the ffi page</a>, it's probably useful to cover the <em>when</em> <code>to_js</code> is needed at all.</p>
<h5 id="background_1">Background</h5>
<p>Despite their similar look on the surface, <em>Python</em> dictionaries and <em>JS</em> object literals are very different primitives:</p>
<div class="language-python highlight"><span class="filename">A Python dict</span><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">ref</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;some&quot;</span><span class="p">:</span> <span class="s2">&quot;thing&quot;</span><span class="p">}</span>
</span></code></pre></div>
<div class="language-js highlight"><span class="filename">A JS literal</span><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">some</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;thing&quot;</span><span class="p">};</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="c1">// equally valid as ...</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;some&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;thing&quot;</span><span class="p">};</span>
</span></code></pre></div>
<p>In both worlds accessing <code>ref["some"]</code> would also produce the same result: pointing at <code>"value"</code> string as result. However, in <em>JS</em> <code>ref.some</code> would also return the very same <code>"value"</code> and while in <em>Python</em> <code>ref.get("some")</code> would do the same, some interpreter preferred to map dictionaries to <em>JS</em> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a> instead, probably because <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map/get">Map.get</a> is really close to what <em>Python</em> dictionaries expect.</p>
<p>Long story short, <em>Pyodide</em> opted for that default conversion but unfortunately all <em>JS</em> APIs are usually expecting object literals, and <em>JS</em> maps don't really work seamlessly the same, so that it's possible to define a different <code>dict_converter</code> in <em>Pyodide</em>, but that definition is verbose and not too <em>DX</em> friendly:</p>
<div class="language-python highlight"><span class="filename">A common Pyodide converter</span><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kn">import</span> <span class="nn">js</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kn">from</span> <span class="nn">pyodide.ffi</span> <span class="kn">import</span> <span class="n">to_js</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">js</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="n">to_js</span><span class="p">(</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="p">{</span><span class="s2">&quot;async&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>        <span class="c1"># transform a Map into an object literal</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>        <span class="n">dict_converter</span><span class="o">=</span><span class="n">js</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">fromEntries</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>    <span class="p">)</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="p">)</span>
</span></code></pre></div>
<p>Beside the fact that <em>MicroPython</em> <code>to_js</code> implementation already converts, by default, <em>Python</em> dictionaries to <em>JS</em> literal, after some experience with common use cases around <em>Python</em> and <em>JS</em> interoperability, we decided to automatically provide an <code>ffi</code> that always results into a <em>JS</em> object literal, so that no converter, unless explicitly defined, would be needed to have the desired result out of the box.</p>
<h4 id="caveats">Caveats</h4>
<p>One fundamental thing to consider when <code>to_js</code> is used, is that it detaches the created reference from its original "<em>source</em>", in this case the <em>Python</em> dictionary, so that any change applied elsewhere to such reference won't ever be reflected to its original counterpart.</p>
<p>This is probably one of the main reasons <em>Pyodide</em> sticked with the dictionary like proxy when it passes its reference to <em>JS</em> callbacks but at the same time no <em>JS</em> callback usually expect a foreign runtime reference to deal with, being this a <em>Python</em> one or any other programming language.</p>
<p>Accordingly, if your <em>JS</em> code is written to explicitly target <em>Pyodide</em> kind of proxies, you probably never need to use <code>to_js</code> as that won't reflect changes to the <em>Python</em> runtime, if changes ever happen within the callback receiving such reference, but if you are just passing <em>data</em> around, data that can be represented as <em>JSON</em>, as example, to configure or pass some option argument to <em>JS</em>, you can simply use our <code>pyscript.ffi.to_js</code> utility and forget about all these details around the conversion: dictionaries will be object literals and lists or tuples will be arrays, that's all you need to remember!</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>